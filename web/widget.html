<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Marathon Finder</title>

<style>
body { font-family: system-ui; padding: 20px; }
.marathon-card { border: 1px solid #ddd; padding: 12px; margin-bottom: 12px; }
button { padding: 8px 12px; cursor: pointer; }
.modal-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,.5);
  display: none; align-items: center; justify-content: center;
}
.modal-overlay.active { display: flex; }
.modal { background: #fff; padding: 20px; width: 360px; }
.success { margin-top: 12px; color: green; }
</style>
</head>

<body>

<h2>üèÉ Marathon Finder</h2>
<div id="marathon-list"></div>

<!-- Modal -->
<div class="modal-overlay" id="modal">
  <div class="modal">
    <h3 id="modal-title"></h3>

    <form id="form">
      <input id="name" placeholder="Full name" required /><br><br>
      <input id="email" placeholder="Email" type="email" required /><br><br>
      <input id="phone" placeholder="Phone" required /><br><br>

      <button type="submit">Continue</button>
      <button type="button" onclick="closeModal()">Cancel</button>
    </form>

    <div id="instructions" style="display:none;"></div>
    <div class="success" id="payment"></div>
  </div>
</div>

<script>
let marathons = []
let selected = null

function openModal(i) {
  selected = marathons[i]
  document.getElementById("modal-title").textContent =
    `Register for ${selected.name}`
  document.getElementById("form").style.display = "block"
  document.getElementById("instructions").style.display = "none"
  document.getElementById("payment").textContent = ""
  document.getElementById("modal").classList.add("active")
}

function closeModal() {
  document.getElementById("modal").classList.remove("active")
}

document.getElementById("form").onsubmit = e => {
  e.preventDefault()

  const payload = {
    marathon_id: selected.id,
    marathon_name: selected.name,
    marathon_city: selected.city,
    marathon_state: selected.state,
    marathon_date: selected.date,
    price_usd: selected.price_usd,
    full_name: name.value,
    email: email.value,
    phone: phone.value
  }

  // Store ONLY for display/debug
  sessionStorage.setItem("registration", JSON.stringify(payload))

  document.getElementById("form").style.display = "none"
  document.getElementById("instructions").style.display = "block"
  document.getElementById("instructions").innerHTML = `
    <p><strong>Almost done.</strong></p>
    <p>Type this in chat to continue:</p>
    <pre>confirm registration</pre>
  `
}

function init() {
  const data = window.openai?.toolOutput ?? {}

  // Render marathons
  if (data.marathons) {
    marathons = data.marathons
    const list = document.getElementById("marathon-list")
    list.innerHTML = ""

    marathons.forEach((m, i) => {
      const div = document.createElement("div")
      div.className = "marathon-card"
      div.innerHTML = `
        <strong>${m.name}</strong><br>
        ${m.city}, ${m.state}<br>
        ${m.price}<br><br>
        <button onclick="openModal(${i})">Register</button>
      `
      list.appendChild(div)
    })
  }

  // Stripe payment link arrives here
  if (data.payment_url) {
    document.getElementById("modal").classList.add("active")
    document.getElementById("payment").innerHTML = `
      ‚úÖ Registration created.<br><br>
      <button onclick="openPayment('${data.payment_url}')">
        Pay Now
      </button>
    `
  }
}

function openPayment(url) {
  window.openai?.openLink
    ? window.openai.openLink(url)
    : window.open(url, "_blank")
}

document.addEventListener("DOMContentLoaded", init)
window.addEventListener("openai:set-globals", init)
</script>

</body>
</html>
